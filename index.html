<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROWTH Tribe Platform</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure custom colors for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#b425aa', // Deep Purple/Pink
                        accent: '#d4af37',  // Gold
                    },
                    fontFamily: {
                         sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styling for the app */
        body {
            background-color: #f9fafb; /* Light background */
        }
        /* Ensure the main content is centered and contained */
        #root {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        /* Style for mobile devices to prevent content overflow outside the app frame */
        .max-w-md.mx-auto {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        /* Style for the fixed header/footer on mobile */
        .fixed.max-w-md.mx-auto {
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body>
    <!-- Root element where the React app will be mounted -->
    <div id="root"></div>

    <!-- Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX and ES6+ support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 
        Firebase Modules: Using stable v11.6.1 CDNs.
        These imports expose the necessary functions globally for the Babel script to consume. 
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for the Babel script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp, increment
        };

        // If the environment provides the global config variables, expose them globally
        if (typeof __firebase_config !== 'undefined') window.__firebase_config = __firebase_config;
        if (typeof __app_id !== 'undefined') window.__app_id = __app_id;
        if (typeof __initial_auth_token !== 'undefined') window.__initial_auth_token = __initial_auth_token;
    </script>

    <!-- Application Code (App.jsx content pasted here) -->
    <script type="text/babel">
        // --- Configuration & Constants ---

        // Hardcoded configuration for external deployment (e.g., GitHub Pages)
        const DEPLOYMENT_FIREBASE_CONFIG = {
          apiKey: "AIzaSyCNUcim4zcv3DwCIIK6Y2O0qxiTKIxIeeY",
          authDomain: "growth-tribe.firebaseapp.com",
          projectId: "growth-tribe",
          storageBucket: "growth-tribe.firebasestorage.app",
          messagingSenderId: "63651197966",
          appId: "1:63651197966:web:af1e5a63a041ab069df85f",
          measurementId: "G-7MR5Z5SNXW"
        };
        const DEPLOYMENT_APP_ID = '1:63651197966:web:af1e5a63a041ab069df85f';
        
        // Use Canvas globals if available, otherwise fall back to the provided configuration
        const firebaseConfig = JSON.parse(window.__firebase_config || JSON.stringify(DEPLOYMENT_FIREBASE_CONFIG));
        const appId = window.__app_id || DEPLOYMENT_APP_ID;

        const THEME = {
          primary: '#b425aa',
          accent: '#d4af37', // Gold
        };

        const LOGO_URL = "https://appimize.app/assets/apps/user_1097/images/2d5cb5dadead_225_1097.png";

        // Re-map imports to global access since we are in a single script context
        // NOTE: We rely on React being loaded via CDN scripts into the global window scope.
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useCallback } = React;
        const { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp, increment 
        } = window.firebase || {};
        
        // --- Lucide Icons (Inline SVG definitions) ---
        // DEFINED FIRST
        const Heart = ({ size, fill, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const MessageCircle = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>;
        const User = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Home = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const PlusCircle = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>;
        const Wallet = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h15"/><path d="M16 12h-4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-2c0-1.1-.9-2-2-2Z"/></svg>;
        const Award = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15.4 11.5 1.4-1.4a2 2 0 0 1 0 2.8l-1.4 1.4"/><path d="m8.6 11.5-1.4-1.4a2 2 0 0 1 0 2.8l1.4 1.4"/><circle cx="12" cy="8" r="6"/><path d="m10 16 2 2 2-2"/></svg>;
        const Sparkles = ({ size, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.9 10.9v1.2M13.5 10.9v1.2M12 8.4v1.2M12 13.5v1.2M17.5 7.5l-1.2 1.2M6.5 14.5l1.2 1.2M18.7 13.5l-1.2-1.2M5.3 8.7l1.2-1.2M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg>;
        const Bot = ({ size, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 19V5"/><path d="M8 9a2 2 0 0 1-2 2h-1a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h1a2 2 0 0 1 2 2z"/><path d="M16 9a2 2 0 0 0 2 2h1a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-1a2 2 0 0 0-2 2z"/><path d="M2 19h20"/><path d="M12 19v2"/></svg>;
        const X = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const Leaf = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.88 6.3l-5-5c-.7-.7-1.4 0-1.4 0s.7.7 0 1.4l5 5A7 7 0 0 1 11 20z"/><path d="M16 4h2l-2 2"/><path d="M19 7h3l-3 3"/><path d="M19 13h3l-3-3"/></svg>;
        const TrendingUp = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 10.5 12.5 5 18"/><path d="M18 7h4v4"/></svg>;
        const Sun = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const LogOut = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;

        // BADGES array definition moved AFTER icon components are defined
        const BADGES = [
          { name: 'Seedling', threshold: 0, icon: <Leaf size={16} /> },
          { name: 'Sprout', threshold: 500, icon: <TrendingUp size={16} /> },
          { name: 'Bloom', threshold: 1000, icon: <Sun size={16} /> },
        ];


        // --- Firebase Initialization ---
        let app, auth, db;
        if (window.firebase && window.firebase.initializeApp && Object.keys(firebaseConfig).length > 0) {
            try {
              app = initializeApp(firebaseConfig);
              auth = getAuth(app);
              db = getFirestore(app);
            } catch (error) {
              // Log the error to help with debugging the connection issue
              console.error("Firebase initialization error (Check your config!):", error);
            }
        } else if (Object.keys(firebaseConfig).length === 0) {
             console.error("Firebase config is empty. Please replace the placeholder in index.html with your actual config.");
        }


        // --- Gemini API Helper (Simulated API Gateway) ---
        const callGemini = async (prompt) => {
          // IMPORTANT: API Key is left as empty string, expected to be provided by the execution environment.
          const apiKey = ""; 
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

          let retries = 0;
          const maxRetries = 5;

          while (retries < maxRetries) {
            try {
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: prompt }] }]
                })
              });

              if (response.ok) {
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "The cosmos is quiet. Please try again.";
              } else if (response.status === 429 || response.status >= 500) {
                retries++;
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
              } else {
                console.error("Gemini API Error (non-retryable):", response.status, await response.text());
                return "Failed to get a response from the AI coach.";
              }
            } catch (error) {
              retries++;
              const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
              await new Promise(resolve => setTimeout(resolve, delay));
            }
          }
          return "Connection interrupted or service is busy. Please try again later.";
        };

        // --- Sub-Components ---

        const NavBtn = ({ icon, label, active, onClick }) => (
          <button 
            onClick={onClick}
            className={`flex flex-col items-center justify-center w-16 transition-colors duration-200 ${active ? 'text-primary' : 'text-gray-400'}`}
          >
            {icon}
            <span className="text-[10px] font-medium mt-1">{label}</span>
          </button>
        );

        const Header = ({ userProfile }) => (
          <header className="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm z-50 px-4 py-3 shadow-sm border-b border-gray-100 flex justify-between items-center max-w-md mx-auto">
            <div className="flex items-center gap-3">
              <img src={LOGO_URL} alt="Growth Tribe" className="w-8 h-8 rounded-full object-cover border-2 border-accent" />
              <h1 className="text-lg font-bold text-primary">GROWTH Tribe</h1>
            </div>
            <div className="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full">
              <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span className="text-xs font-bold text-gray-700">{userProfile?.points || 0} GP</span>
            </div>
          </header>
        );

        const PostCard = ({ post, user, onLike }) => {
          const isLiked = post.likes && user && post.likes[user.uid];
          
          const formatDate = (timestamp) => {
            if (!timestamp) return 'Just now';
            // Check if it's a Firestore Timestamp object and convert, otherwise assume it's already a Date/timestamp
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); 
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          };

          return (
            <div className="bg-white mb-4 rounded-xl shadow-md border border-gray-100 p-4">
              <div className="flex items-start justify-between">
                <div className="flex gap-3">
                  <img 
                    src={post.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.authorId}`} 
                    className="w-10 h-10 rounded-full object-cover border-2 border-primary" 
                    alt="avatar" 
                  />
                  <div>
                    <h3 className="font-bold text-sm text-gray-900">{post.authorName}</h3>
                    <span className="text-xs text-gray-500">{formatDate(post.timestamp)}</span>
                  </div>
                </div>
              </div>
              <p className="text-gray-800 whitespace-pre-wrap leading-relaxed my-3 font-light text-[15px]">{post.content}</p>
              
              <div className="flex items-center justify-between border-t border-gray-50 pt-3 mt-2">
                <button 
                  onClick={() => onLike(post)}
                  className={`flex items-center gap-1.5 text-sm font-medium transition-colors ${isLiked ? 'text-pink-600' : 'text-gray-500 hover:text-pink-600'}`}
                >
                  <Heart size={20} fill={isLiked ? "currentColor" : "none"} />
                  <span>{post.likeCount || 0}</span>
                </button>
                <button className="flex items-center gap-1.5 text-sm font-medium text-gray-500 hover:text-primary">
                    <MessageCircle size={20} />
                    <span>{post.commentCount || 0}</span>
                </button>
              </div>
            </div>
          );
        };

        const CreatePostModal = ({ onClose, onSubmit }) => {
          const [content, setContent] = useState('');
          const [isSubmitting, setIsSubmitting] = useState(false);

          const handleSubmit = async () => {
            if (!content.trim()) return;
            setIsSubmitting(true);
            await onSubmit({ content });
            setIsSubmitting(false);
            onClose();
          };

          return (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
              <div className="bg-white w-full max-w-lg sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col">
                <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-700">Cancel</button>
                  <h2 className="font-bold text-lg text-gray-800">New Post</h2>
                  <button 
                    onClick={handleSubmit} 
                    disabled={!content.trim() || isSubmitting}
                    className={`font-bold px-4 py-1.5 rounded-full transition-colors ${content.trim() ? 'bg-primary text-white hover:bg-primary/90' : 'bg-gray-200 text-gray-400'}`}
                  >
                    {isSubmitting ? 'Posting...' : 'Post'}
                  </button>
                </div>
                
                <div className="p-4">
                  <textarea
                    className="w-full h-32 text-lg resize-none outline-none placeholder-gray-400 p-2 border border-gray-100 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="Share your growth journey..."
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    autoFocus
                  />
                </div>
              </div>
            </div>
          );
        };

        const AiCoachModal = ({ onClose }) => {
          const [input, setInput] = useState('');
          const [response, setResponse] = useState('');
          const [loading, setLoading] = useState(false);

          const handleAskCoach = async () => {
            if (!input.trim() || loading) return;
            setLoading(true);
            setResponse('');
            
            const prompt = `Act as a wise and empathetic personal growth coach for the 'GROWTH Tribe'. The user says: "${input}". 
            Provide a warm, supportive response (max 3 sentences) validating their feelings, followed by ONE small, actionable 'Growth Step' they can take right now. 
            Format: "Response... \n\nðŸŒ± **Growth Step:** ..."`;
            
            const result = await callGemini(prompt);
            setResponse(result);
            setLoading(false);
          };

          return (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
              <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div className="bg-primary p-4 text-white flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <Bot size={24} className="text-accent" />
                    <h2 className="font-bold text-lg">Growth Coach</h2>
                  </div>
                  <button onClick={onClose} className="text-white/80 hover:text-white"><X size={24}/></button>
                </div>

                <div className="p-6 flex-1 overflow-y-auto">
                  {!response ? (
                    <>
                      <p className="text-gray-600 mb-4 text-center">
                        What's on your mind today?
                      </p>
                      <textarea 
                        className="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 resize-none h-32 focus:border-primary focus:ring-2 focus:ring-primary/50"
                        placeholder="I'm feeling a bit overwhelmed..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                      />
                      <button 
                        onClick={handleAskCoach}
                        disabled={!input.trim() || loading}
                        className="w-full mt-4 bg-accent text-white font-bold py-3 rounded-xl shadow-md hover:bg-accent/90 disabled:opacity-50 transition-colors"
                      >
                        {loading ? 'Thinking...' : 'âœ¨ Get Guidance'}
                      </button>
                    </>
                  ) : (
                    <div className="space-y-4">
                      <div className="flex gap-3">
                        <div className="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0 text-white">
                          <Bot size={16} />
                        </div>
                        <div className="bg-gray-100 p-4 rounded-xl text-gray-800 text-sm whitespace-pre-wrap">
                          {response}
                        </div>
                      </div>
                      <button 
                        onClick={() => { setInput(''); setResponse(''); }}
                        className="w-full mt-6 text-primary font-semibold text-sm hover:underline"
                      >
                        Ask something else
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // --- Main App Component ---

        const App = () => {
          const [user, setUser] = useState(null);
          const [userProfile, setUserProfile] = useState(null);
          const [activeTab, setActiveTab] = useState('home');
          const [posts, setPosts] = useState([]);
          // Set initial loading state based on successful Firebase initialization
          const [loading, setLoading] = useState(!auth || !db); 
          const [showCreatePost, setShowCreatePost] = useState(false);
          const [showAiCoach, setShowAiCoach] = useState(false);
          
          // 1. Auth & Initial Load
          useEffect(() => {
            if (!auth || !db) {
                // If auth or db are null, it means Firebase failed to initialize
                // due to a missing or invalid config. We stay in loading state.
                setLoading(true);
                return;
            }

            const initAuth = async () => {
              try {
                // In deployed environment, window.__initial_auth_token is likely null,
                // so we sign in anonymously for public access.
                const token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
                if (token) {
                  await signInWithCustomToken(auth, token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (err) {
                console.error("Auth failed:", err);
              }
            };
            initAuth();

            const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
              setUser(currentUser);
              setLoading(false); // Authentication attempt finished, hide loading screen
              
              if (currentUser) {
                // Public profile listener for points/badges
                const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid);
                
                // ADDED DEBUG LOG: Check if this path matches your rules!
                console.log(`[Firestore] Listening to Profile Path: artifacts/${appId}/public/data/profiles/${currentUser.uid}`);
                
                // Listener for the user profile data
                const unsubscribeProfile = onSnapshot(profileRef, (snap) => {
                  if (snap.exists()) {
                    setUserProfile({ uid: currentUser.uid, ...snap.data() });
                  } else {
                    // Create initial profile if it doesn't exist
                    const initialData = {
                      displayName: `GrowthUser_${currentUser.uid.slice(0, 4)}`,
                      points: 100, // Welcome bonus
                      avatarUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`,
                      joinedAt: serverTimestamp(),
                      userId: currentUser.uid // Include for debugging/sharing
                    };
                    // Use setDoc to ensure the profile document is created
                    setDoc(profileRef, initialData, { merge: true });
                    setUserProfile({ uid: currentUser.uid, ...initialData });
                  }
                }, (error) => console.error("Profile snapshot error: Missing or insufficient permissions. Check your Firestore Security Rules.", error));
                
                return () => unsubscribeProfile();
              } else {
                  setUserProfile(null);
              }
            });

            return () => unsubscribeAuth();
          }, []);

          // 2. Fetch Posts (Data Backend)
          useEffect(() => {
            // Only fetch data if the user object is available AND Firebase is initialized
            if (!user || !db) return;

            const postsCollectionPath = `artifacts/${appId}/public/data/posts`;
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            
            // ADDED DEBUG LOG
            console.log(`[Firestore] Listening to Posts Collection: ${postsCollectionPath}`);

            // Real-time listener for posts
            const unsubscribePosts = onSnapshot(postsRef, (snapshot) => {
              const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              // Sort manually by timestamp for latest first
              fetchedPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
              setPosts(fetchedPosts);
            }, (error) => {
              console.error("Error fetching posts: Missing or insufficient permissions. Check your Firestore Security Rules.", error);
            });

            return () => unsubscribePosts();
          }, [user]);

          // 3. Actions (Data Manipulation Backend)
          const handleCreatePost = useCallback(async (postData) => {
            if (!user || !userProfile || !db) return;

            // Find current badge for display on the post (snapshot of time of posting)
            const currentBadge = BADGES.slice().reverse().find(b => userProfile.points >= b.threshold)?.name || 'Seedling';

            const newPost = {
              authorId: user.uid,
              authorName: userProfile.displayName,
              authorAvatar: userProfile.avatarUrl,
              content: postData.content,
              timestamp: serverTimestamp(),
              likeCount: 0,
              commentCount: 0,
              likes: {},
              badge: currentBadge
            };

            try {
              // Add Post
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), newPost);
              
              // Award Points (+10 for posting)
              const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user.uid);
              await updateDoc(profileRef, { points: increment(10) });
              
            } catch (error) {
              console.error("Error creating post or updating points:", error);
            }
          }, [user, userProfile]);

          const handleLike = useCallback(async (post) => {
            if (!user || !db) return;
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', post.id);
            const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', post.authorId);

            const isLiked = post.likes && post.likes[user.uid];
            const userIsAuthor = post.authorId === user.uid;

            try {
              if (isLiked) {
                // Unlike
                const newLikes = { ...post.likes };
                delete newLikes[user.uid];
                await updateDoc(postRef, {
                  likes: newLikes,
                  likeCount: increment(-1)
                });
                
                // Deduct points from post author if not self-liking (optional logic)
                if (!userIsAuthor) {
                   await updateDoc(profileRef, { points: increment(-1) });
                }

              } else {
                // Like
                const newLikes = { ...post.likes, [user.uid]: true };
                await updateDoc(postRef, {
                  likes: newLikes,
                  likeCount: increment(1)
                });
                
                // Award Points to post author (+1 for engagement)
                if (!userIsAuthor) {
                   await updateDoc(profileRef, { points: increment(1) });
                }
              }
            } catch (error) {
              console.error("Error handling like:", error);
            }
          }, [user]);

          // 4. View Rendering
          if (loading || (!user && !auth && Object.keys(firebaseConfig).length === 0)) { 
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                <div className="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p className="mt-4 font-medium text-primary">
                    {Object.keys(firebaseConfig).length === 0 
                        ? "ERROR: Firebase Config Missing. Check console." 
                        : "Establishing Connection..."}
                </p>
              </div>
            );
          }
          
          if (!userProfile) {
             // Handle state where user is authenticated but profile data hasn't loaded yet
             return (
                 <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                    <div className="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                    <p className="mt-4 font-medium text-accent">Loading User Profile...</p>
                </div>
             )
          }

          return (
            <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
              <style>{`
                /* Ensure Poppins is used if available */
                @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
                .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
              `}</style>
              
              {/* Header is max-width aligned to main content */}
              <Header userProfile={userProfile} />

              <main className="max-w-md mx-auto min-h-screen relative shadow-2xl shadow-gray-200 overflow-hidden pt-16">
                
                {/* Hub View (Data Feed) */}
                {activeTab === 'home' && (
                  <div className="p-4 pt-4">
                     {/* AI Coach Trigger */}
                     <div className="bg-gradient-to-r from-primary/90 to-accent/90 rounded-xl p-4 text-white mb-6 shadow-lg flex justify-between items-center">
                        <h2 className="font-semibold text-sm">Need guidance?</h2>
                        <button 
                          onClick={() => setShowAiCoach(true)}
                          className="bg-white/20 hover:bg-white/30 text-white border border-white/40 rounded-full px-3 py-1 text-xs font-bold flex items-center gap-2 transition-all"
                        >
                          <Sparkles size={14} className="text-[#ffd700]" />
                          <span>Talk to Coach</span>
                        </button>
                     </div>

                     <h3 className="font-bold text-gray-700 mb-4 px-1">Community Feed</h3>
                     
                     {posts.length === 0 ? (
                       <div className="text-center py-10 opacity-50">
                         <Leaf size={48} className="mx-auto mb-2 text-gray-400" />
                         <p>Be the first to plant a seed!</p>
                       </div>
                     ) : (
                       posts.map(post => (
                         <PostCard 
                            key={post.id} 
                            post={post} 
                            user={user} 
                            onLike={handleLike} 
                         />
                       ))
                     )}
                  </div>
                )}

                {/* Profile View (User Data) */}
                {activeTab === 'profile' && (
                  <div className="p-4 pt-8">
                    <div className="text-center mb-8">
                      <img 
                        src={userProfile.avatarUrl} 
                        className="w-24 h-24 mx-auto rounded-full mb-3 border-4 border-accent object-cover" 
                        alt="avatar" 
                      />
                      <h2 className="text-2xl font-bold text-gray-900">{userProfile.displayName}</h2>
                      <p className="text-xs text-gray-500 mt-1">User ID: {userProfile.userId}</p>
                      <div className="flex items-center justify-center gap-2 mt-2 text-primary font-medium bg-gray-100 py-1 px-3 rounded-full mx-auto w-fit">
                        {/* Ensure the icon renders correctly */}
                        {BADGES.slice().reverse().find(b => userProfile.points >= b.threshold)?.icon}
                        <span>{BADGES.slice().reverse().find(b => userProfile.points >= b.threshold)?.name}</span>
                      </div>
                      
                      <div className="mt-8 p-4 bg-white border border-gray-100 rounded-xl shadow-inner">
                          <h3 className="font-bold text-lg text-gray-700 mb-3">Your Milestones</h3>
                          <ul className="space-y-2 text-left">
                              {BADGES.map(badge => (
                                  <li key={badge.name} className={`flex items-center justify-between p-3 rounded-lg ${userProfile.points >= badge.threshold ? 'bg-green-50 text-green-700' : 'bg-gray-50 text-gray-500'}`}>
                                      <div className="flex items-center gap-3">
                                          {/* Ensure the icon renders correctly */}
                                          {badge.icon}
                                          <span className="font-semibold">{badge.name}</span>
                                      </div>
                                      <span className="text-sm">{badge.threshold} GP</span>
                                  </li>
                              ))}
                          </ul>
                      </div>
                    </div>
                    
                    <button 
                      onClick={() => auth.signOut()} 
                      className="w-full mt-6 bg-red-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-red-600 flex justify-center items-center gap-2"
                    >
                      <LogOut size={20} /> Sign Out
                    </button>
                  </div>
                )}

                {/* Placeholder for Wallet/Badges */}
                {(activeTab === 'wallet' || activeTab === 'badges') && (
                    <div className="pt-20 text-center p-4">
                        <h2 className="text-2xl font-bold text-gray-500">Feature Coming Soon!</h2>
                        <p className="text-gray-400 mt-2">Current Points: {userProfile.points} GP</p>
                    </div>
                )}
              </main>

              {/* Modals & Overlays */}
              {showCreatePost && (
                <CreatePostModal 
                  onClose={() => setShowCreatePost(false)} 
                  onSubmit={handleCreatePost}
                />
              )}

              {showAiCoach && (
                <AiCoachModal onClose={() => setShowAiCoach(false)} />
              )}
              
              {/* Create Tab Trigger */}
              {activeTab === 'create' && (() => {
                // Immediately reset tab and open modal
                setTimeout(() => {
                  setActiveTab('home');
                  setShowCreatePost(true);
                }, 0);
                return null;
              })()}


              {/* Bottom Navigation */}
              <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 px-4 py-2 flex justify-between items-center z-50 safe-area-bottom shadow-lg">
                <NavBtn icon={<Home size={24} />} label="Hub" active={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                <NavBtn icon={<Wallet size={24} />} label="Wallet" active={activeTab === 'wallet'} onClick={() => setActiveTab('wallet')} />
                
                <button 
                  onClick={() => setActiveTab('create')}
                  className="relative -top-5 bg-primary text-white p-4 rounded-full shadow-xl border-4 border-gray-50 transition-transform active:scale-95 hover:scale-[1.05]"
                >
                  <PlusCircle size={32} />
                </button>
                
                <NavBtn icon={<Award size={24} />} label="Badges" active={activeTab === 'badges'} onClick={() => setActiveTab('badges')} />
                <NavBtn icon={<User size={24} />} label="Profile" active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} />
              </div>
            </div>
          );
        };
        
        // --- React Mount ---
        // Render the App component to the 'root' div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
