<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROWTH Tribe</title>
    <!-- PWA and Styling Enhancements -->
    <meta name="theme-color" content="#b425aa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure custom colors for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#b425aa', // Deep Purple/Pink
                        accent: '#d4af37',  // Gold
                    },
                    fontFamily: {
                         sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styling for the app */
        body {
            background-color: #f9fafb; /* Light background */
            font-family: 'Poppins', sans-serif;
        }
        /* Ensure the main content is centered and contained */
        #root {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .max-w-md.mx-auto {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .fixed.max-w-md.mx-auto {
            left: 50%;
            transform: translateX(-50%);
        }
        .custom-spinner {
            border-top-color: theme('colors.accent');
            border-left-color: theme('colors.accent');
            border-bottom-color: theme('colors.primary');
            border-right-color: theme('colors.primary');
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client Import -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 
      FIX: Initialize Supabase client outside the text/babel block (in a standard script) 
      to resolve the 'Cannot read properties of null (reading 'createClient')' error, 
      ensuring the Supabase library is fully loaded before use.
    -->
    <script>
        const SUPABASE_URL = 'https://kjffnjcswakrmoqumbzn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqZmZuamNzd2Frcm1vcXVtYnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTU0NjksImV4cCI6MjA3OTMzMTQ2OX0.5fG3qJU3bLpXos94C1mGEJ7TueeK2pKh0Ov9f91fVp8'; 
        
        window.supabaseClient = null;
        window.isSupabaseConfigValid = true;

        try {
            // Check if window.supabase exists before calling createClient
            if (window.supabase) {
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized successfully with provided keys.");
            } else {
                console.error("Supabase library not loaded on window object.");
                window.isSupabaseConfigValid = false;
            }
        } catch (error) {
            console.error("Supabase client creation failed:", error);
            window.isSupabaseConfigValid = false;
        }
    </script>


    <!-- Supabase Configuration and Client Initialization -->
    <script type="text/babel">
        // --- Configuration & Constants ---
        
        const LOGO_URL = "https://appimize.app/assets/apps/user_1097/images/2d5cb5dadead_225_1097.png";
        
        // Use the globally set flags and client
        const isSupabaseConfigValid = window.isSupabaseConfigValid;
        let supabase = window.supabaseClient; 


        // --- MOCK USER SETUP (Fixed State) ---
        const MOCK_USER = {
            uid: "mock-user-12345",
            email: "mock@growthtribe.com",
            displayName: "Growth Enthusiast",
        };

        const MOCK_PROFILE_BASE = {
            displayName: MOCK_USER.displayName,
            points: 850, 
            avatarUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${MOCK_USER.uid}`,
            last_post_date: '2025-11-30', 
            user_id: MOCK_USER.uid, // Column name adjusted for snake_case convention
        };

        // Re-map imports to global access
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- Utility Functions ---
        const formatDate = (timestamp) => {
          if (!timestamp) return 'Just now';
          const date = new Date(timestamp); 
          return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };
        
        const getTodayDateString = () => {
            return new Date().toISOString().split('T')[0];
        };

        // --- Lucide Icons (Inline SVG definitions - same as previous) ---
        const Heart = ({ size, fill, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const MessageCircle = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>;
        const User = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Home = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const PlusCircle = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>;
        const Wallet = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h15"/><path d="M16 12h-4c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-2c0-1.1-.9-2-2-2Z"/></svg>;
        const Award = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15.4 11.5 1.4-1.4a2 2 0 0 1 0 2.8l-1.4 1.4"/><path d="m8.6 11.5-1.4-1.4a2 2 0 0 1 0 2.8l1.4 1.4"/><circle cx="12" cy="8" r="6"/><path d="m10 16 2 2 2-2"/></svg>;
        const Sparkles = ({ size, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.9 10.9v1.2M13.5 10.9v1.2M12 8.4v1.2M12 13.5v1.2M17.5 7.5l-1.2 1.2M6.5 14.5l1.2 1.2M18.7 13.5l-1.2-1.2M5.3 8.7l1.2-1.2M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/></svg>;
        const Bot = ({ size, className, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 19V5"/><path d="M8 9a2 2 0 0 1-2 2h-1a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h1a2 2 0 0 1 2 2z"/><path d="M16 9a2 2 0 0 0 2 2h1a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-1a2 2 0 0 0-2 2z"/><path d="M2 19h20"/><path d="M12 19v2"/></svg>;
        const X = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const Leaf = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.88 6.3l-5-5c-.7-.7-1.4 0-1.4 0s.7.7 0 1.4l5 5A7 7 0 0 1 11 20z"/><path d="M16 4h2l-2 2"/><path d="M19 7h3l-3 3"/><path d="M19 13h3l-3-3"/></svg>;
        const TrendingUp = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 10.5 12.5 5 18"/><path d="M18 7h4v4"/></svg>;
        const Sun = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const PiggyBank = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 5H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h13"/><path d="M21 7v10a2 2 0 0 1-2 2h-1"/><path d="M6 14h2"/><path d="M12 14h2"/><path d="M10 5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/></svg>;
        const Gift = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6"/><path d="M12 2v4"/><path d="M19 12H5"/><path d="M17 6c0-1.1-1-2-2-2s-2 1-2 2c0 1.1 1 2 2 2s2-1 2-2zM7 6c0-1.1 1-2 2-2s2 1 2 2c0 1.1-1 2-2 2s-2-1-2-2z"/></svg>;
        const CalendarCheck = ({ size, ...props }) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/></svg>;


        const BADGES = [
          { name: 'Seedling', threshold: 0, icon: <Leaf size={16} />, description: 'Just started your journey!'},
          { name: 'Sprout', threshold: 100, icon: <TrendingUp size={16} />, description: 'Consistency is key. You are making progress.'},
          { name: 'Bloom', threshold: 500, icon: <Sun size={16} />, description: 'Flowering into your potential. Keep shining!'},
          { name: 'Thrive', threshold: 1500, icon: <Heart size={16} fill="currentColor" />, description: 'You are thriving and inspiring others.'},
          { name: 'Eco-System Master', threshold: 5000, icon: <Award size={16} />, description: 'Achieved harmony and mastery in your ecosystem.'},
        ];
        
        // --- Gemini API Helper (Same as previous) ---
        const callGemini = async (prompt) => {
          const apiKey = ""; 
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

          let retries = 0;
          const maxRetries = 5;

          while (retries < maxRetries) {
            try {
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: prompt }] }]
                })
              });

              if (response.ok) {
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "The cosmos is quiet. Please try again.";
              } else if (response.status === 429 || response.status >= 500) {
                retries++;
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
              } else {
                console.error("Gemini API Error (non-retryable):", response.status, await response.text());
                return "Failed to get a response from the AI coach.";
              }
            } catch (error) {
              retries++;
              const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
              await new Promise(resolve => setTimeout(resolve, delay));
            }
          }
          return "Connection interrupted or service is busy. Please try again later.";
        };


        // --- Sub-Components (Unchanged UI) ---

        const NavBtn = ({ icon, label, active, onClick }) => (
          <button 
            onClick={onClick}
            className={`flex flex-col items-center justify-center w-16 transition-colors duration-200 ${active ? 'text-primary' : 'text-gray-400'}`}
          >
            {icon}
            <span className="text-[10px] font-medium mt-1">{label}</span>
          </button>
        );

        const Header = ({ userProfile }) => (
          <header className="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm z-50 px-4 py-3 shadow-md border-b border-gray-100 flex justify-between items-center max-w-md mx-auto">
            <div className="flex items-center gap-3">
              <img src={LOGO_URL} alt="Growth Tribe" className="w-8 h-8 rounded-full object-cover border-2 border-accent" />
              <h1 className="text-lg font-bold text-primary">GROWTH Tribe</h1>
            </div>
            {userProfile && (
                <div className="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full">
                  <PiggyBank size={14} className="text-accent" />
                  <span className="text-xs font-bold text-gray-700">{userProfile?.points || 0} GP</span>
                </div>
            )}
          </header>
        );

        const PostCard = ({ post, user, onLike }) => {
          // Note: Supabase stores likes as JSONB, so accessing is similar to Firestore map
          const isLiked = post.likes && user && post.likes[user.uid]; 
          
          const PostBadge = ({ badgeName }) => {
            const badge = BADGES.find(b => b.name === badgeName);
            if (!badge) return null;
            return (
              <div className="flex items-center gap-1.5 text-xs font-semibold px-2 py-0.5 rounded-full bg-accent/20 text-accent ml-2">
                {badge.icon}
                <span>{badge.name}</span>
              </div>
            );
          };

          return (
            <div className="bg-white mb-4 rounded-xl shadow-md border border-gray-100 p-4">
              <div className="flex items-start justify-between">
                <div className="flex gap-3">
                  <img 
                    src={post.author_avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.author_id}`} 
                    className="w-10 h-10 rounded-full object-cover border-2 border-primary" 
                    alt="avatar" 
                  />
                  <div>
                    <div className="flex items-center">
                        <h3 className="font-bold text-sm text-gray-900">{post.author_name}</h3>
                        {post.badge && <PostBadge badgeName={post.badge} />}
                    </div>
                    <span className="text-xs text-gray-500">{formatDate(post.created_at)}</span>
                  </div>
                </div>
              </div>
              <p className="text-gray-800 whitespace-pre-wrap leading-relaxed my-3 font-light text-[15px]">{post.content}</p>
              
              <div className="flex items-center justify-between border-t border-gray-50 pt-3 mt-2">
                <button 
                  onClick={() => onLike(post)}
                  className={`flex items-center gap-1.5 text-sm font-medium transition-colors ${isLiked ? 'text-pink-600' : 'text-gray-500 hover:text-pink-600'}`}
                >
                  <Heart size={20} fill={isLiked ? "currentColor" : "none"} />
                  <span>{post.like_count || 0}</span>
                </button>
                <button className="flex items-center gap-1.5 text-sm font-medium text-gray-500 hover:text-primary">
                    <MessageCircle size={20} />
                    <span>{post.comment_count || 0}</span>
                </button>
              </div>
            </div>
          );
        };

        const WalletView = ({ userProfile, transactions }) => {
            return (
                <div className="p-4 pt-8">
                    <div className="bg-gradient-to-br from-primary to-accent rounded-2xl p-6 text-white shadow-xl mb-6">
                        <div className="flex justify-between items-center">
                            <PiggyBank size={32} className="text-white"/>
                            <h2 className="text-sm font-semibold opacity-80">Growth Points (GP)</h2>
                        </div>
                        <p className="text-5xl font-extrabold mt-3">{userProfile.points}</p>
                        <p className="text-sm mt-1 opacity-90">Current balance</p>
                    </div>

                    <h3 className="font-bold text-gray-700 mb-3 px-1">Recent Transactions</h3>
                    <div className="bg-white rounded-xl shadow-md divide-y divide-gray-100 border border-gray-100 overflow-hidden">
                        {transactions.length === 0 ? (
                            <div className="p-4 text-center text-gray-400 text-sm">No transactions yet. Post something!</div>
                        ) : (
                            transactions.map((tx, index) => (
                                <div key={tx.id || index} className="flex justify-between items-center p-4 hover:bg-gray-50 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`p-2 rounded-full ${tx.amount > 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                            {tx.amount > 0 ? <PlusCircle size={18} /> : <X size={18} />}
                                        </div>
                                        <div>
                                            <p className="font-medium text-sm text-gray-800">{tx.description}</p>
                                            <p className="text-xs text-gray-400">{formatDate(tx.created_at)}</p>
                                        </div>
                                    </div>
                                    <span className={`font-bold text-base ${tx.amount > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {tx.amount > 0 ? '+' : ''}{tx.amount} GP
                                    </span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };
        
        const BadgesView = ({ userProfile }) => {
            const currentPoints = userProfile.points || 0;

            const nextBadge = BADGES.find(b => currentPoints < b.threshold);
            const currentBadge = useMemo(() => {
                return BADGES.slice().reverse().find(b => currentPoints >= b.threshold);
            }, [currentPoints]);

            const progress = nextBadge ? Math.min(100, ((currentPoints - (currentBadge?.threshold || 0)) / (nextBadge.threshold - (currentBadge?.threshold || 0))) * 100) : 100;

            return (
                <div className="p-4 pt-8">
                    {/* Current Badge Status */}
                    <div className="bg-white rounded-2xl p-6 shadow-xl border border-primary/20 mb-6 text-center">
                        <div className="text-primary mx-auto w-12 h-12 flex items-center justify-center mb-3">
                           {currentBadge?.icon && React.cloneElement(currentBadge.icon, { size: 48, className: "text-primary" })}
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900">{currentBadge?.name || 'Unranked'}</h2>
                        <p className="text-sm text-gray-500 mt-1">{currentBadge?.description}</p>
                        
                        {nextBadge && (
                            <div className="mt-4">
                                <p className="text-xs font-semibold text-gray-600 mb-1">Next: {nextBadge.name} ({nextBadge.threshold} GP)</p>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                    <div 
                                        className="bg-accent h-2.5 rounded-full transition-all duration-500" 
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <h3 className="font-bold text-gray-700 mb-4 px-1">All Growth Milestones</h3>
                    <div className="space-y-3">
                        {BADGES.map((badge) => {
                            const earned = currentPoints >= badge.threshold;
                            return (
                                <div 
                                    key={badge.name} 
                                    className={`flex items-start p-4 rounded-xl border transition-all ${earned ? 'bg-primary/10 border-primary/40' : 'bg-gray-50 border-gray-200 opacity-60'}`}
                                >
                                    <div className={`p-2 rounded-full mr-4 flex-shrink-0 ${earned ? 'bg-primary text-white' : 'bg-gray-200 text-gray-500'}`}>
                                        {React.cloneElement(badge.icon, { size: 20 })}
                                    </div>
                                    <div className="flex-grow">
                                        <h4 className={`font-bold ${earned ? 'text-primary' : 'text-gray-700'}`}>{badge.name}</h4>
                                        <p className="text-sm text-gray-600">{badge.description}</p>
                                    </div>
                                    <span className={`text-sm font-semibold mt-1 ${earned ? 'text-primary' : 'text-gray-500'}`}>
                                        {badge.threshold} GP
                                    </span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        const CreatePostModal = ({ onClose, onSubmit, dailyBonus }) => {
          const [content, setContent] = useState('');
          const [isSubmitting, setIsSubmitting] = useState(false);

          const handleSubmit = async () => {
            if (!content.trim()) return;
            setIsSubmitting(true);
            await onSubmit({ content });
            setIsSubmitting(false);
            onClose();
          };
          
          const bonusText = dailyBonus ? 'Daily Bonus Active (+50 GP)' : 'Community Post (+10 GP)';

          return (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
              <div className="bg-white w-full max-w-lg sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col">
                <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-700">Cancel</button>
                  <h2 className="font-bold text-lg text-gray-800">New Post</h2>
                  <button 
                    onClick={handleSubmit} 
                    disabled={!content.trim() || isSubmitting}
                    className={`font-bold px-4 py-1.5 rounded-full transition-colors ${content.trim() ? 'bg-primary text-white hover:bg-primary/90' : 'bg-gray-200 text-gray-400'}`}
                  >
                    {isSubmitting ? 'Posting...' : 'Post'}
                  </button>
                </div>
                
                <div className="p-4">
                  <div className={`text-xs font-medium px-3 py-1 mb-3 rounded-full w-fit ${dailyBonus ? 'bg-accent/20 text-accent' : 'bg-gray-100 text-gray-500'}`}>
                    {dailyBonus && <CalendarCheck size={14} className="inline mr-1 -mt-0.5" />}
                    {bonusText}
                  </div>
                  <textarea
                    className="w-full h-32 text-lg resize-none outline-none placeholder-gray-400 p-2 border border-gray-100 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                    placeholder="Share your growth journey..."
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    autoFocus
                  />
                </div>
              </div>
            </div>
          );
        };

        const AiCoachModal = ({ onClose }) => {
          const [input, setInput] = useState('');
          const [response, setResponse] = useState('');
          const [loading, setLoading] = useState(false);

          const handleAskCoach = async () => {
            if (!input.trim() || loading) return;
            setLoading(true);
            setResponse('');
            
            const prompt = `Act as a wise and empathetic personal growth coach for the 'GROWTH Tribe'. The user says: "${input}". 
            Provide a warm, supportive response (max 3 sentences) validating their feelings, followed by ONE small, actionable 'Growth Step' they can take right now. 
            Format: "Response... \n\nüå± **Growth Step:** ..."`;
            
            const result = await callGemini(prompt);
            setResponse(result);
            setLoading(false);
          };

          return (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
              <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div className="bg-primary p-4 text-white flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <Bot size={24} className="text-accent" />
                    <h2 className="font-bold text-lg">Growth Coach</h2>
                  </div>
                  <button onClick={onClose} className="text-white/80 hover:text-white"><X size={24}/></button>
                </div>

                <div className="p-6 flex-1 overflow-y-auto">
                  {!response ? (
                    <>
                      <p className="text-gray-600 mb-4 text-center">
                        What's on your mind today?
                      </p>
                      <textarea 
                        className="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 resize-none h-32 focus:border-primary focus:ring-2 focus:ring-primary/50"
                        placeholder="I'm feeling a bit overwhelmed..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                      />
                      <button 
                        onClick={handleAskCoach}
                        disabled={!input.trim() || loading}
                        className="w-full mt-4 bg-accent text-white font-bold py-3 rounded-xl shadow-md hover:bg-accent/90 disabled:opacity-50 transition-colors"
                      >
                        {loading ? 'Thinking...' : '‚ú® Get Guidance'}
                      </button>
                    </>
                  ) : (
                    <div className="space-y-4">
                      <div className="flex gap-3">
                        <div className="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0 text-white">
                          <Bot size={16} />
                        </div>
                        <div className="bg-gray-100 p-4 rounded-xl text-gray-800 text-sm whitespace-pre-wrap">
                          {response}
                        </div>
                      </div>
                      <button 
                        onClick={() => { setInput(''); setResponse(''); }}
                        className="w-full mt-6 text-primary font-semibold text-sm hover:underline"
                      >
                        Ask something else
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };


        // --- Main App Component ---

        const App = () => {
          const user = MOCK_USER; 
          
          const [userProfile, setUserProfile] = useState(MOCK_PROFILE_BASE);
          const [activeTab, setActiveTab] = useState('home');
          const [posts, setPosts] = useState([]);
          const [transactions, setTransactions] = useState([]);
          const [loading, setLoading] = useState(isSupabaseConfigValid); 
          const [showCreatePost, setShowCreatePost] = useState(false);
          const [showAiCoach, setShowAiCoach] = useState(false);
          
          const userId = user.uid;
          
          // Determine if the user gets the daily bonus (uses userProfile.last_post_date)
          const isDailyBonusAvailable = useMemo(() => {
              if (!userProfile) return false;
              const today = getTodayDateString();
              return userProfile.last_post_date !== today;
          }, [userProfile]);

          // Render config error if key is missing
          if (!isSupabaseConfigValid || !supabase) {
             return (
                <div className="flex flex-col items-center justify-center min-h-screen w-full p-4 text-center">
                    <div className="max-w-md bg-red-50 border-2 border-red-300 rounded-xl p-6 shadow-xl">
                        <X size={48} className="mx-auto mb-4 text-red-600" />
                        <h1 className="text-xl font-bold text-red-800">Supabase API Key Error</h1>
                        <p className="mt-2 text-sm text-gray-700">
                            The application cannot connect to the database because of an initialization error.
                        </p>
                        <p className="mt-4 text-xs text-gray-500">
                            Please check the console for details. (Supabase client not initialized)
                        </p>
                    </div>
                </div>
             );
          }


          // 1. Initial Profile Setup & Listener (Supabase)
          useEffect(() => {
            // Guard clause if supabase is null (shouldn't happen here due to outer check, but safe practice)
            if (!supabase) return; 

            const fetchProfile = async () => {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 means "not found"
                    console.error("Profile fetch error:", error);
                }
                
                if (data) {
                    // Inject points into MOCK_PROFILE_BASE for consistent lookups (like in handleLike logic)
                    setUserProfile({ ...data, points: data.points || 0 }); 
                } else {
                    // If profile doesn't exist, create it (INSERT)
                    console.log("Mock User profile missing. Creating initial profile.");
                    const { data: newProfile, error: insertError } = await supabase
                        .from('profiles')
                        .insert([MOCK_PROFILE_BASE])
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error("Profile insert error:", insertError);
                    } else {
                        setUserProfile(newProfile);
                    }
                }
                setLoading(false);
            };

            fetchProfile();

            // Setup Realtime Listener for Profile (updates points, etc.)
            const channel = supabase
                .channel('profile_changes')
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `user_id=eq.${userId}` },
                    (payload) => {
                        console.log('Profile update received:', payload.new);
                        setUserProfile(payload.new);
                    }
                )
                .subscribe();

            return () => {
                // Ensure supabase exists before removing channel
                if (supabase) supabase.removeChannel(channel);
            };
          }, [userId]); 

          // 2. Fetch Posts (Data Feed) - Using Realtime
          useEffect(() => {
            if (!supabase) return;

            const fetchAndSetPosts = async () => {
                const { data, error } = await supabase
                    .from('posts')
                    .select('*') 
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Error fetching posts:", error);
                } else {
                    setPosts(data);
                }
            };

            fetchAndSetPosts();

            // Setup Realtime Listener for Posts
            const channel = supabase
                .channel('posts_changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'posts' },
                    () => fetchAndSetPosts() // Simple re-fetch on any change
                )
                .subscribe();

            return () => {
                if (supabase) supabase.removeChannel(channel);
            };
          }, []); 

          // 3. Fetch Transactions (Wallet) - Using Realtime
          useEffect(() => {
            if (!supabase) return;

            const fetchAndSetTransactions = async () => {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Error fetching transactions:", error);
                } else {
                    setTransactions(data);
                }
            };

            fetchAndSetTransactions();

            // Setup Realtime Listener for Transactions
            const channel = supabase
                .channel('transactions_changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'transactions', filter: `user_id=eq.${userId}` },
                    () => fetchAndSetTransactions() // Simple re-fetch on change for this user
                )
                .subscribe();

            return () => {
                if (supabase) supabase.removeChannel(channel);
            };
          }, [userId]);

          // 4. Actions (Data Manipulation Backend)
          const handleCreatePost = useCallback(async (postData) => {
            if (!userProfile || !supabase) return;

            const currentBadge = BADGES.slice().reverse().find(b => userProfile.points >= b.threshold)?.name || 'Seedling';
            
            const todayDateString = getTodayDateString();
            const isFirstPostToday = userProfile.last_post_date !== todayDateString;
            const pointsGained = isFirstPostToday ? 50 : 10;
            const newLastPostDate = isFirstPostToday ? todayDateString : userProfile.last_post_date;

            const newPost = {
              author_id: userId,
              author_name: userProfile.displayName,
              author_avatar: userProfile.avatarUrl,
              content: postData.content,
              like_count: 0,
              comment_count: 0,
              likes: {}, // JSONB column
              badge: currentBadge
              // created_at is handled by Postgres default now()
            };

            try {
              // 1. Add Post (INSERT)
              const { error: postError } = await supabase
                .from('posts')
                .insert([newPost]);
              
              if (postError) throw postError;

              // 2. Award Points and update last_post_date (UPDATE)
              const newPoints = userProfile.points + pointsGained;

              const { error: profileError } = await supabase
                .from('profiles')
                .update({ 
                    points: newPoints, 
                    last_post_date: newLastPostDate 
                })
                .eq('user_id', userId);

              if (profileError) throw profileError;

              // 3. Log the transaction (INSERT)
              const { error: transactionError } = await supabase
                .from('transactions')
                .insert([{
                    user_id: userId,
                    type: isFirstPostToday ? 'Daily Post Bonus' : 'Community Post',
                    description: isFirstPostToday ? 'First post of the day for consistency.' : 'Regular community contribution.',
                    amount: pointsGained,
                    // created_at is handled by Postgres default now()
                }]);

              if (transactionError) throw transactionError;
              
            } catch (error) {
              console.error("Error creating post or updating points:", error);
            }
          }, [userId, userProfile, supabase]);

          const handleLike = useCallback(async (post) => {
            if (!supabase) return;
            
            const isLiked = post.likes && post.likes[userId];
            const userIsAuthor = post.author_id === userId;
            
            try {
              let newLikes = { ...post.likes };
              let pointChange = 0;

              if (isLiked) {
                // Unlike: Remove user from likes map and decrement count
                delete newLikes[userId];
                // Revoke point from post author for unlike (Only if the liker is not the author)
                if (!userIsAuthor) pointChange = -1; 
              } else {
                // Like: Add user to likes map and increment count
                newLikes[userId] = true;
                // Award point to post author for like (Only if the liker is not the author)
                if (!userIsAuthor) pointChange = 1; 
              }

              // 1. Update Post (likes and like_count)
              const { error: postUpdateError } = await supabase
                .from('posts')
                .update({ 
                    likes: newLikes, 
                    like_count: (post.like_count || 0) + (isLiked ? -1 : 1)
                })
                .eq('id', post.id);

              if (postUpdateError) throw postUpdateError;

              // 2. Update Post Author's Profile Points 
              if (pointChange !== 0) {
                
                // Fetch the post author's profile to get current points
                const { data: authorProfile, error: fetchAuthorError } = await supabase
                    .from('profiles')
                    .select('points')
                    .eq('user_id', post.author_id)
                    .single();
                    
                if (fetchAuthorError || !authorProfile) {
                    // Log error but proceed, as post update was successful
                    console.error("Could not fetch author profile for point update:", fetchAuthorError);
                    return; 
                }

                const authorNewPoints = authorProfile.points + pointChange;
                
                const { error: profileUpdateError } = await supabase
                  .from('profiles')
                  .update({ points: authorNewPoints })
                  .eq('user_id', post.author_id);

                if (profileUpdateError) throw profileUpdateError;
                
                // Log the transaction for the post author (only if points changed)
                const txDescription = pointChange > 0 ? `Post liked by ${userProfile.displayName}` : `Post unliked by ${userProfile.displayName}`;
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert([{
                        user_id: post.author_id,
                        type: 'Post Like Reward',
                        description: txDescription,
                        amount: pointChange,
                    }]);
                
                if (transactionError) console.error("Error logging like transaction:", transactionError);
              }
              
            } catch (error) {
              console.error("Error handling like:", error);
            }
          }, [userId, userProfile, supabase]);

          // 5. View Rendering
          
          if (loading || !userProfile) { 
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                <div className="w-16 h-16 border-4 custom-spinner rounded-full animate-spin"></div>
                <p className="mt-4 font-medium text-accent">
                    Connecting to Supabase and Loading Profile...
                </p>
              </div>
            );
          }
          
          return (
            <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-900">
              
              <Header userProfile={userProfile} />

              <main className="max-w-md mx-auto min-h-screen relative shadow-2xl shadow-gray-200 overflow-hidden pt-16">
                
                {/* Hub View (Data Feed) */}
                {activeTab === 'home' && (
                  <div className="p-4 pt-4">
                     <div className="bg-white rounded-xl p-4 mb-6 shadow-md border-l-4 border-primary/70">
                        <p className="text-sm italic text-gray-700 leading-relaxed">
                            Welcome back to your journey from an **‚Äúego-system‚Äù** to an **‚Äúeco-system‚Äù** ‚Äî embracing growth, resilience, overall well-being, transformation, and harmony.
                        </p>
                     </div>

                     {/* AI Coach Trigger */}
                     <div className="bg-gradient-to-r from-primary/90 to-accent/90 rounded-xl p-4 text-white mb-6 shadow-lg flex justify-between items-center">
                        <h2 className="font-semibold text-sm">Need guidance?</h2>
                        <button 
                          onClick={() => setShowAiCoach(true)}
                          className="bg-white/20 hover:bg-white/30 text-white border border-white/40 rounded-full px-3 py-1 text-xs font-bold flex items-center gap-2 transition-all"
                        >
                          <Sparkles size={14} className="text-[#ffd700]" />
                          <span>Talk to Coach</span>
                        </button>
                     </div>

                     <h3 className="font-bold text-gray-700 mb-4 px-1">Community Feed</h3>
                     
                     {posts.length === 0 ? (
                       <div className="text-center py-10 opacity-50">
                         <Leaf size={48} className="mx-auto mb-2 text-gray-400" />
                         <p>Be the first to plant a seed!</p>
                       </div>
                     ) : (
                       posts.map(post => (
                         <PostCard 
                            key={post.id} 
                            post={post} 
                            user={user} 
                            onLike={handleLike} 
                         />
                       ))
                     )}
                  </div>
                )}

                {/* Wallet View */}
                {activeTab === 'wallet' && <WalletView userProfile={userProfile} transactions={transactions} />}

                {/* Badges View */}
                {activeTab === 'badges' && <BadgesView userProfile={userProfile} />}

                {/* Profile View (User Data) */}
                {activeTab === 'profile' && (
                  <div className="p-4 pt-8">
                    <div className="text-center mb-8">
                      <img 
                        src={userProfile.avatarUrl} 
                        className="w-24 h-24 mx-auto rounded-full mb-3 border-4 border-accent object-cover" 
                        alt="avatar" 
                      />
                      <h2 className="text-2xl font-bold text-gray-900">{userProfile.displayName}</h2>
                      <p className="text-xs text-gray-500 mt-1">User ID: {userProfile.user_id}</p>
                      <p className="text-xs text-gray-400">Supabase Backend (Mock Auth)</p>
                      
                      <div className="mt-8 p-4 bg-white border border-gray-100 rounded-xl shadow-inner">
                          <h3 className="font-bold text-lg text-primary mb-3">Your Eco-System Status</h3>
                          <div className="flex justify-between items-center p-3 rounded-lg bg-gray-50 mb-3">
                              <span className="flex items-center gap-2 text-sm text-gray-700 font-medium">
                                  <PiggyBank size={20} className="text-accent"/>
                                  Growth Points
                              </span>
                              <span className="font-bold text-lg text-primary">{userProfile.points} GP</span>
                          </div>
                          <div className="flex justify-between items-center p-3 rounded-lg bg-gray-50">
                              <span className="flex items-center gap-2 text-sm text-gray-700 font-medium">
                                  <Gift size={20} className="text-red-500"/>
                                  Daily Bonus Status
                              </span>
                              <span className={`font-bold text-sm ${isDailyBonusAvailable ? 'text-green-600' : 'text-red-500'}`}>
                                  {isDailyBonusAvailable ? 'Available!' : 'Completed Today'}
                              </span>
                          </div>
                      </div>
                    </div>
                  </div>
                )}

              </main>

              {/* Modals & Overlays */}
              {showCreatePost && (
                <CreatePostModal 
                  onClose={() => setShowCreatePost(false)} 
                  onSubmit={handleCreatePost}
                  dailyBonus={isDailyBonusAvailable}
                />
              )}

              {showAiCoach && (
                <AiCoachModal onClose={() => setShowAiCoach(false)} />
              )}
              
              {/* Create Tab Trigger */}
              {activeTab === 'create' && (() => {
                setTimeout(() => {
                  setActiveTab('home');
                  setShowCreatePost(true);
                }, 0);
                return null;
              })()}


              {/* Bottom Navigation */}
              <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 px-4 py-2 flex justify-between items-center z-50 safe-area-bottom shadow-lg">
                <NavBtn icon={<Home size={24} />} label="Hub" active={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                <NavBtn icon={<Wallet size={24} />} label="Wallet" active={activeTab === 'wallet'} onClick={() => setActiveTab('wallet')} />
                
                <button 
                  onClick={() => setActiveTab('create')}
                  className="relative -top-5 bg-primary text-white p-4 rounded-full shadow-xl border-4 border-gray-50 transition-transform active:scale-95 hover:scale-[1.05]"
                >
                  <PlusCircle size={32} />
                </button>
                
                <NavBtn icon={<Award size={24} />} label="Badges" active={activeTab === 'badges'} onClick={() => setActiveTab('badges')} />
                <NavBtn icon={<User size={24} />} label="Profile" active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} />
              </div>
            </div>
          );
        };
        
        // --- React Mount ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
